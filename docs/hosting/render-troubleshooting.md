# Troubleshooting Lỗi 502/503 trên Render

Hướng dẫn này sẽ giúp bạn khắc phục các lỗi 502 (Bad Gateway) và 503 (Service Unavailable) khi deploy Sure lên Render.

## Hiểu về lỗi 502 và 503

- **502 Bad Gateway**: Render không thể kết nối đến application server (Puma). Thường do:
  - Application server không chạy hoặc crash
  - Application không bind đúng port
  - Application timeout khi khởi động
  - Database connection failed
  - Missing environment variables

- **503 Service Unavailable**: Service đang quá tải hoặc đang restart. Thường do:
  - Service đang deploy/restart
  - Health check failed
  - Out of memory
  - Too many requests

## Bước 1: Kiểm tra Logs

### 1.1. Xem Build Logs

1. Vào **sure-web** service trên Render Dashboard
2. Click tab **"Logs"**
3. Scroll xuống để xem build logs
4. Tìm các lỗi trong quá trình build:
   - `bundle install` failed
   - `rails assets:precompile` failed
   - Missing dependencies

**Common Build Errors**:

```bash
# Lỗi: RAILS_MASTER_KEY missing
# Giải pháp: Thêm RAILS_MASTER_KEY vào environment variables

# Lỗi: Database connection failed during build
# Giải pháp: Đây là bình thường, database chỉ cần khi app chạy

# Lỗi: Asset precompilation failed
# Giải pháp: Kiểm tra Node.js version, đảm bảo có đủ memory
```

### 1.2. Xem Runtime Logs

1. Vào **sure-web** service
2. Click tab **"Logs"**
3. Xem runtime logs để tìm lỗi khi app chạy

**Common Runtime Errors**:

```bash
# Lỗi: "RAILS_MASTER_KEY is missing"
# => Thêm RAILS_MASTER_KEY vào environment variables

# Lỗi: "Database connection failed"
# => Kiểm tra DATABASE_URL, đảm bảo dùng Internal Database URL

# Lỗi: "Redis connection failed"
# => Kiểm tra REDIS_URL, đảm bảo dùng Internal Redis URL

# Lỗi: "Port already in use"
# => Render tự động set PORT, không cần set thủ công

# Lỗi: "Address already in use"
# => Service đang restart, đợi vài phút
```

## Bước 2: Kiểm tra Environment Variables

### 2.1. Kiểm tra các biến bắt buộc

Vào **sure-web** → **"Environment"** và đảm bảo có:

```bash
✅ RAILS_ENV=production
✅ RAILS_MASTER_KEY=<your_master_key>
✅ SECRET_KEY_BASE=<auto-generated>
✅ DATABASE_URL=<from sure-db>
✅ REDIS_URL=<from sure-redis>
✅ HOST=finance.tonyx.dev  # Domain của bạn
✅ PORT=10000  # Render tự set, nhưng cần khai báo
```

### 2.2. Lấy RAILS_MASTER_KEY

Nếu thiếu `RAILS_MASTER_KEY` hoặc không có file `config/master.key`:

**Cách 1: Tạo master key mới (Nếu chưa có file)**

```bash
# Trên máy local
cd ~/agentx/sure

# Tạo master key mới
EDITOR="nano" rails credentials:edit

# Hoặc nếu dùng VS Code
EDITOR="code --wait" rails credentials:edit
```

Lệnh này sẽ tự động tạo `config/master.key` nếu chưa có.

**Cách 2: Lấy từ file hiện có**

```bash
# Trên máy local
cat config/master.key

# Copy toàn bộ nội dung (chỉ 1 dòng) và paste vào Render Environment Variables
```

**Cách 3: Generate thủ công (Nếu không có credentials)**

```bash
# Generate master key
openssl rand -hex 32

# Lưu vào file
echo "your_generated_key" > config/master.key
```

Sau đó copy giá trị và paste vào Render Environment Variables.

### 2.3. Kiểm tra Database URL

**⚠️ CỰC KỲ QUAN TRỌNG**: Phải dùng **Internal Database URL**, KHÔNG PHẢI External!

**Tại sao phải dùng Internal URL?**
- ✅ Nhanh hơn (không đi qua internet)
- ✅ Ổn định hơn (không bị timeout)
- ✅ Bảo mật hơn (chỉ truy cập trong Render network)
- ✅ Miễn phí bandwidth

**External URL sẽ gây lỗi 502/503!**

1. Vào **sure-db** service
2. Tab **"Connections"**
3. Copy **"Internal Database URL"** (có dạng: `postgresql://sure_user:password@dpg-xxx:5432/sure_production`)
   - **KHÔNG** dùng External URL (có `?sslmode=require`)
4. Paste vào `DATABASE_URL` của web service
5. **XÓA** External URL nếu đã có

### 2.4. Kiểm tra Redis URL

**⚠️ CỰC KỲ QUAN TRỌNG**: Phải dùng **Internal Redis URL**, KHÔNG PHẢI External!

**Tại sao phải dùng Internal URL?**
- ✅ Nhanh hơn và ổn định hơn
- ✅ Không bị connection timeout
- ✅ WebSocket (Action Cable) hoạt động tốt hơn

**External URL sẽ gây lỗi 502/503 và WebSocket failed!**

1. Vào **sure-redis** service
2. Tab **"Connections"**
3. Copy **"Internal Redis URL"** (có dạng: `redis://red-xxxxx:6379`)
   - **KHÔNG** dùng External URL (có query params hoặc password)
4. Paste vào `REDIS_URL` của web và worker service
5. **XÓA** External URL nếu đã có

## Bước 3: Kiểm tra Application Status

### 3.1. Kiểm tra Service Status

1. Vào **sure-web** service
2. Xem status:
   - **"Live"** = Đang chạy bình thường
   - **"Deploying"** = Đang deploy, đợi hoàn tất
   - **"Build Failed"** = Build lỗi, xem build logs
   - **"Deploy Failed"** = Deploy lỗi, xem runtime logs
   - **"Stopped"** = Service đã dừng, cần restart

### 3.2. Kiểm tra Health Check

1. Vào **sure-web** → **"Settings"** → **"Health Check Path"**
2. Đảm bảo set là `/` (root path)
3. Test health check:
   ```bash
   curl https://finance.tonyx.dev/
   ```

## Bước 4: Kiểm tra Database Connection

### 4.1. Test Database Connection

1. Vào **sure-web** → **"Shell"**
2. Chạy:

```bash
bundle exec rails runner "puts ActiveRecord::Base.connection.execute('SELECT 1').first"
```

Nếu lỗi, kiểm tra:
- `DATABASE_URL` đúng chưa
- Database service đang chạy chưa
- Database đã được tạo chưa

### 4.2. Chạy Migrations

Nếu database chưa có tables:

```bash
# Trong Render Shell
bundle exec rails db:create db:migrate
```

## Bước 5: Kiểm tra Redis Connection

### 5.1. Test Redis Connection

1. Vào **sure-web** → **"Shell"**
2. Chạy:

```bash
bundle exec rails runner "puts Redis.new(url: ENV['REDIS_URL']).ping"
```

Nếu lỗi, kiểm tra:
- `REDIS_URL` đúng chưa
- Redis service đang chạy chưa

## Bước 6: Kiểm tra Puma Configuration

### 6.1. Đảm bảo Puma bind đúng port

File `config/puma.rb` đã đúng:

```ruby
port ENV.fetch("PORT") { 3000 }
```

Render tự động set `PORT=10000`, Puma sẽ tự động bind port này.

### 6.2. Kiểm tra Start Command

Trong **sure-web** → **"Settings"** → **"Start Command"**:

```bash
bundle exec puma -C config/puma.rb
```

**KHÔNG** dùng:
```bash
# ❌ SAI
bundle exec rails server
bundle exec puma -p 3000
```

## Bước 7: Kiểm tra Action Cable (WebSocket)

### 7.1. Cấu hình Action Cable

File `config/cable.yml` đã đúng:

```yaml
production:
  adapter: redis
  url: <%= ENV.fetch("REDIS_URL") { "redis://localhost:6379/1" } %>
  channel_prefix: sure_production
```

### 7.2. Cấu hình Action Cable URL

Thêm vào `config/environments/production.rb`:

```ruby
config.action_cable.url = "wss://#{ENV.fetch('HOST', 'localhost')}/cable"
config.action_cable.allowed_request_origins = [
  "https://#{ENV.fetch('HOST', 'localhost')}",
  /https:\/\/.*\.#{ENV.fetch('HOST', 'localhost')}/
]
```

### 7.3. Mount Action Cable

Đảm bảo Action Cable được mount trong `config/routes.rb`:

```ruby
mount ActionCable.server => '/cable'
```

## Bước 8: Kiểm tra Memory và Resources

### 8.1. Xem Memory Usage

1. Vào **sure-web** → **"Metrics"**
2. Xem memory usage:
   - Nếu > 80%: Cần upgrade plan hoặc optimize
   - Nếu > 100%: Service sẽ bị kill và restart

### 8.2. Upgrade Plan nếu cần

1. Vào **sure-web** → **"Settings"** → **"Plan"**
2. Upgrade lên plan cao hơn nếu:
   - Memory usage thường xuyên > 80%
   - CPU usage cao
   - Service thường xuyên restart

## Bước 9: Restart Services

### 9.1. Manual Restart

1. Vào **sure-web** service
2. Click **"Manual Deploy"**
3. Chọn **"Clear build cache & deploy"**
4. Click **"Deploy"**

### 9.2. Restart từ Shell

```bash
# Trong Render Shell
# Không thể restart trực tiếp, cần dùng Manual Deploy
```

## Bước 10: Common Fixes

### Fix 1: RAILS_MASTER_KEY Missing

```bash
# 1. Lấy master key từ local
cat config/master.key

# 2. Vào Render → sure-web → Environment
# 3. Thêm: RAILS_MASTER_KEY=<paste_key_here>
# 4. Save và restart service
```

### Fix 2: Database Connection Failed

```bash
# 1. Vào sure-db → Connections
# 2. Copy Internal Database URL
# 3. Vào sure-web → Environment
# 4. Update DATABASE_URL với Internal URL
# 5. Save và restart
```

### Fix 3: Redis Connection Failed

```bash
# 1. Vào sure-redis → Connections
# 2. Copy Internal Redis URL
# 3. Vào sure-web → Environment
# 4. Update REDIS_URL với Internal URL
# 5. Save và restart
```

### Fix 4: Port Already in Use

```bash
# 1. Đảm bảo PORT không được set thủ công
# 2. Xóa biến PORT nếu đã set
# 3. Render sẽ tự động set PORT=10000
# 4. Restart service
```

### Fix 5: Asset Precompilation Failed

```bash
# 1. Kiểm tra build logs
# 2. Đảm bảo có đủ memory (upgrade plan nếu cần)
# 3. Kiểm tra Node.js version
# 4. Clear build cache và rebuild
```

### Fix 6: WebSocket Connection Failed

```bash
# 1. Đảm bảo REDIS_URL đúng
# 2. Kiểm tra config/cable.yml
# 3. Thêm Action Cable config vào production.rb (xem Bước 7)
# 4. Restart service
```

## Bước 11: Debug với Rails Console

### 11.1. Mở Rails Console

1. Vào **sure-web** → **"Shell"**
2. Chạy:

```bash
bundle exec rails console
```

### 11.2. Test các connections

```ruby
# Test database
ActiveRecord::Base.connection.execute("SELECT 1")

# Test Redis
Redis.new(url: ENV['REDIS_URL']).ping

# Test environment
ENV['RAILS_ENV']
ENV['DATABASE_URL']
ENV['REDIS_URL']
ENV['HOST']
ENV['PORT']
```

## Bước 12: Kiểm tra Network và DNS

### 12.1. Test Domain

```bash
# Test domain resolution
nslookup finance.tonyx.dev

# Test HTTPS
curl -I https://finance.tonyx.dev/

# Test health check
curl https://finance.tonyx.dev/
```

### 12.2. Kiểm tra DNS

1. Đảm bảo domain trỏ đúng về Render
2. Kiểm tra CNAME record:
   ```
   finance.tonyx.dev CNAME your-app-name.onrender.com
   ```

## Checklist Debugging

Trước khi báo lỗi, kiểm tra:

- [ ] Service status là "Live"
- [ ] Build logs không có lỗi
- [ ] Runtime logs không có lỗi
- [ ] `RAILS_MASTER_KEY` đã được set
- [ ] `DATABASE_URL` dùng Internal URL
- [ ] `REDIS_URL` dùng Internal URL
- [ ] `HOST` đúng với domain
- [ ] `PORT` không được set thủ công (Render tự set)
- [ ] Database migrations đã chạy
- [ ] Database service đang chạy
- [ ] Redis service đang chạy
- [ ] Memory usage < 80%
- [ ] Health check path là `/`
- [ ] Action Cable đã được cấu hình
- [ ] Domain DNS đúng

## Liên hệ Support

Nếu vẫn gặp lỗi sau khi thử tất cả các bước trên:

1. Thu thập thông tin:
   - Build logs (screenshot)
   - Runtime logs (screenshot)
   - Environment variables (ẩn sensitive data)
   - Service metrics

2. Tạo ticket tại [Render Support](https://render.com/support)

3. Mô tả chi tiết:
   - Lỗi gì (502/503)
   - Khi nào xảy ra
   - Đã thử gì
   - Logs và screenshots

## Tài nguyên

- [Render Documentation](https://render.com/docs)
- [Render Troubleshooting](https://render.com/docs/troubleshooting)
- [Rails on Render](https://render.com/docs/deploy-rails)
